{% extends "base.html" %}

{% block title %}Staff Dashboard - Aneri Beauty Care{% endblock %}

{% block content %}
<div class="staff-dashboard py-5 bg-light">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                    <div class="card-body p-4">
                        <h2 class="mb-2">
                            <i class="bi bi-person-badge"></i> Staff Dashboard
                        </h2>
                        <p class="mb-0">Manage your appointments and deliveries</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Profile</h5>
                    </div>
                    <div class="card-body">
                        <h6 id="staffNameDisplay">Staff</h6>
                        <p class="text-muted small" id="staffEmailDisplay"></p>
                        <div class="mb-2"><strong>Phone:</strong> <span id="staffPhoneDisplay">-</span></div>
                        <div class="mb-2"><strong>Available:</strong> <span id="staffAvailable">-</span></div>
                        <hr>
                        <button class="btn btn-sm btn-outline-primary mb-3" id="editStaffBtn"><i class="bi bi-pencil"></i> Edit Profile</button>
                        <h6>Assigned Services</h6>
                        <ul id="assignedServicesList" class="list-group list-group-flush small"></ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Today's Work</h5>
                        <small id="todayDate" class="text-muted"></small>
                    </div>
                    <div class="card-body">
                        <div id="todaysWorkContainer">
                            <div class="text-center text-muted py-4" id="todaysLoading">
                                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Upcoming Assignments</h5>
                    </div>
                    <div class="card-body">
                        <div id="upcomingContainer"></div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Deliveries</h5>
                    </div>
                    <div class="card-body">
                        <div id="deliveriesContainer">
                            <div class="text-center text-muted py-3" id="deliveriesLoading">
                                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function(){
    const userStr = localStorage.getItem(window.APP_CONFIG.USER_KEY);
    const user = userStr ? JSON.parse(userStr) : null;
    if (user) {
        document.getElementById('staffNameDisplay').textContent = user.name || 'Staff';
        document.getElementById('staffEmailDisplay').textContent = user.email || '';
    }

    // load staff profile for display (phone / availability)
    async function updateStaffProfileDisplay(){
        try{
            const s = await window.apiClient.getMyStaff();
            const staffObj = s && (s.staff || s);
            if (staffObj) {
                document.getElementById('staffPhoneDisplay').textContent = staffObj.phone || '-';
                document.getElementById('staffAvailable').textContent = (staffObj.is_available ? 'Yes' : 'No');
            }
        } catch (err) {
            console.error('Failed to load staff profile display', err);
        }
    }

    document.getElementById('todayDate').textContent = new Date().toLocaleDateString();

    await loadStaffDashboard();
    await updateStaffProfileDisplay();
    // wire edit modal
    const editBtn = document.getElementById('editStaffBtn');
    const editModalEl = document.getElementById('editStaffModal');
    const editModal = new bootstrap.Modal(editModalEl);
    editBtn && editBtn.addEventListener('click', async function(){
        // load my staff profile; if missing, create it then load
        try{
            let s = null;
            try { s = await window.apiClient.getMyStaff(); } catch(e) { s = null; }
            if (!s) {
                // create minimal profile
                try {
                    await window.apiClient.createMyStaff({ phone: '' });
                    s = await window.apiClient.getMyStaff();
                } catch (createErr) {
                    console.error('Failed to create staff profile', createErr);
                    s = null;
                }
            }

            if (s && s.staff) {
                document.getElementById('editStaffPhone').value = s.staff.phone || '';
                document.getElementById('editStaffAvailable').checked = !!s.staff.is_available;
            } else if (s && s.id) {
                document.getElementById('editStaffPhone').value = s.phone || '';
                document.getElementById('editStaffAvailable').checked = !!s.is_available;
            }
        } catch (err) {
            console.error('Error loading staff profile for edit', err);
        }
        editModal.show();
    });

    document.getElementById('saveStaffProfileBtn').addEventListener('click', async function(){
        const phone = document.getElementById('editStaffPhone').value.trim();
        const is_available = document.getElementById('editStaffAvailable').checked;
        try{
            LoadingOverlay.show('Saving...');
            await window.apiClient.updateMyStaffProfile({ phone: phone || undefined, is_available });
            LoadingOverlay.hide();
            editModal.hide();
            Toast.success('Profile updated');
            await loadStaffDashboard();
            await updateStaffProfileDisplay();
        } catch (err) {
            LoadingOverlay.hide();
            console.error('Failed to save staff profile', err);
            Toast.error(err.message || 'Failed to update profile');
        }
    });
});

async function loadStaffDashboard(){
    // load assignments
    try{
        const assigns = await window.apiClient.getStaffAssignments();
        const today = new Date();
        const todays = assigns.filter(a => {
            if (!a.start_datetime) return false;
            const d = new Date(a.start_datetime);
            return d.toDateString() === today.toDateString();
        });
        const upcoming = assigns.filter(a => {
            if (!a.start_datetime) return false;
            const d = new Date(a.start_datetime);
            return d.toDateString() !== today.toDateString();
        });

        // assigned services: distinct service_name
        const serviceSet = new Set(assigns.map(a => a.service_name).filter(Boolean));
        const svcList = Array.from(serviceSet);
        const svcUl = document.getElementById('assignedServicesList');
        svcUl.innerHTML = svcList.length ? svcList.map(s=>`<li class="list-group-item small">${s}</li>`).join('') : '<li class="list-group-item small text-muted">No services assigned yet</li>';

        // Today's work
        const tcont = document.getElementById('todaysWorkContainer');
        if (todays.length === 0) {
            tcont.innerHTML = '<div class="text-center text-muted py-4">No work scheduled for today</div>';
        } else {
            tcont.innerHTML = todays.map(a => {
                const start = a.start_datetime ? new Date(a.start_datetime).toLocaleTimeString() : '-';
                const end = a.end_datetime ? new Date(a.end_datetime).toLocaleTimeString() : '-';
                return `<div class="d-flex justify-content-between align-items-center border rounded p-3 mb-2">
                    <div>
                        <div class="fw-bold">${a.service_name || 'Service'} (${a.type})</div>
                        <div class="text-muted small">${a.customer_name || 'Customer'} — ${start} - ${end}</div>
                    </div>
                    <span class="badge ${a.status === 'approved' ? 'bg-success' : a.status === 'pending' ? 'bg-warning text-dark' : 'bg-secondary'}">${a.status}</span>
                </div>`;
            }).join('');
        }

        // Upcoming
        const ucont = document.getElementById('upcomingContainer');
        if (upcoming.length === 0) {
            ucont.innerHTML = '<div class="text-muted">No upcoming assignments</div>';
        } else {
            ucont.innerHTML = upcoming.map(a => {
                const dt = a.start_datetime ? new Date(a.start_datetime).toLocaleString() : '-';
                return `<div class="border-bottom py-2">
                    <div class="fw-bold">${a.service_name || 'Service'} — ${a.type}</div>
                    <div class="small text-muted">${dt} • ${a.customer_name || 'Customer'}</div>
                </div>`;
            }).join('');
        }
    } catch (err) {
        console.error('Failed to load staff assignments', err);
        document.getElementById('todaysWorkContainer').innerHTML = '<div class="text-danger">Failed to load assignments</div>';
    }

    // load deliveries assigned to this staff
    try{
        const delResp = await window.apiClient.getMyDeliveries();
        const dcont = document.getElementById('deliveriesContainer');
        if (!delResp || delResp.length === 0) {
            dcont.innerHTML = '<div class="text-muted">No deliveries assigned</div>';
        } else {
            dcont.innerHTML = delResp.map(d => {
                const del = d.delivery || {};
                const order = d.order || {};
                const cust = d.customer || {};
                const address = (cust.address || (order && order.address) || 'N/A');
                const phone = cust.phone || '-';
                return `
                    <div class="border rounded p-3 mb-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-bold">Order #${order.id || del.order_id}</div>
                                <div class="small text-muted">${cust.user_id ? (cust.user_id) : ''} • ${phone}</div>
                                <div class="small">${address}</div>
                            </div>
                            <div class="text-end">
                                <div class="mb-2"><span class="badge bg-info">${del.status || 'pending'}</span></div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="updateDelivery(${del.id}, 'out_for_delivery')">Mark Out</button>
                                    <button class="btn btn-sm btn-success ms-1" onclick="updateDelivery(${del.id}, 'delivered')">Mark Delivered</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (err) {
        console.error('Failed to load deliveries', err);
        document.getElementById('deliveriesContainer').innerHTML = '<div class="text-danger">Failed to load deliveries</div>';
    }
}

async function updateDelivery(id, status){
    try{
        await window.apiClient.updateDeliveryStatus(id, status);
        Toast.success('Delivery updated');
        await loadStaffDashboard();
    } catch (err) {
        console.error('Failed to update delivery', err);
        Toast.error(err.message || 'Failed to update delivery');
    }
}
</script>
<!-- Edit Staff Modal moved here to avoid being replaced by dashboard updates -->
<div class="modal fade" id="editStaffModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Staff Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStaffForm">
                    <div class="mb-3"><label class="form-label">Phone</label><input id="editStaffPhone" class="form-control"></div>
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox" id="editStaffAvailable">
                        <label class="form-check-label" for="editStaffAvailable">Available for assignments</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="saveStaffProfileBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
