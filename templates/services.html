{% extends "base.html" %}

{% block title %}Services - Aneri Beauty Care{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header bg-gradient-primary text-white py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <h1 class="display-4 fw-bold">Our Services</h1>
                <p class="lead">Discover our range of premium beauty and wellness services</p>
            </div>
        </div>
    </div>
</section>

<!-- Services Section -->
<section class="services-section py-5">
    <div class="container py-5">
        <!-- Filter and Search -->
        <div class="row mb-4">
            <div class="col-lg-4 mb-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchServices" placeholder="Search services...">
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <select class="form-select" id="filterCategory">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-lg-4 mb-3">
                <select class="form-select" id="sortServices">
                    <option value="name">Sort by Name</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="duration">Duration</option>
                </select>
            </div>
        </div>
        
        <!-- Services Grid -->
        <div class="row g-4" id="servicesGrid">
            <!-- Loading Spinner -->
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading services...</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let allServices = [];
let allCategories = [];

document.addEventListener('DOMContentLoaded', async function() {
    await loadCategories();
    await loadServices();
    setupEventListeners();
});

async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        const data = await response.json();
        const categoriesArray = Array.isArray(data) ? data : (data.categories || []);
        
        if (response.ok && categoriesArray.length) {
            allCategories = categoriesArray;
            const categorySelect = document.getElementById('filterCategory');
            
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadServices() {
    const grid = document.getElementById('servicesGrid');
    
    try {
        const response = await fetch('/api/services');
        const data = await response.json();
        const servicesArray = Array.isArray(data) ? data : (data.services || []);
        
        if (response.ok && servicesArray.length) {
            allServices = servicesArray;
            displayServices(allServices);
        } else {
            grid.innerHTML = `
                <div class="col-12 text-center">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No services available at the moment.
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading services:', error);
        grid.innerHTML = `
            <div class="col-12 text-center">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Failed to load services. Please try again later.
                </div>
            </div>
        `;
    }
}

function displayServices(services) {
    const grid = document.getElementById('servicesGrid');
    
    if (services.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center">
                <p class="text-muted">No services found.</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = services.map(service => `
        <div class="col-lg-4 col-md-6">
            <div class="card service-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="service-icon">
                            <i class="bi bi-scissors text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <span class="badge bg-primary">${getCategoryName(service.category_id)}</span>
                    </div>
                    
                    <h5 class="card-title fw-bold">${service.name}</h5>
                    <p class="card-text text-muted">${service.description || 'Professional beauty service'}</p>
                    
                    <div class="service-details mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">
                                <i class="bi bi-clock"></i> ${service.duration_mins ?? service.duration} mins
                            </span>
                            <span class="fw-bold text-primary h5 mb-0">â‚¹${service.price}</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 p-3">
                    <button class="btn btn-primary w-100 book-service-btn" data-service-id="${service.id}" data-service-name="${service.name}" data-service-type="${service.service_type || 'in-center'}">
                        <i class="bi bi-calendar-check"></i> Book Now
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    // Add event listeners to book buttons
    document.querySelectorAll('.book-service-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const serviceId = this.dataset.serviceId;
            const serviceName = this.dataset.serviceName;
            const serviceType = this.dataset.serviceType || '';
            bookService(serviceId, serviceName, serviceType);
        });
    });
}

function getCategoryName(categoryId) {
    const category = allCategories.find(c => c.id == categoryId);
    return category ? category.name : 'General';
}

function setupEventListeners() {
    // Search
    document.getElementById('searchServices').addEventListener('input', filterAndSort);
    
    // Filter
    document.getElementById('filterCategory').addEventListener('change', filterAndSort);
    
    // Sort
    document.getElementById('sortServices').addEventListener('change', filterAndSort);
}

function filterAndSort() {
    const searchTerm = document.getElementById('searchServices').value.toLowerCase();
    const categoryFilter = document.getElementById('filterCategory').value;
    const sortBy = document.getElementById('sortServices').value;
    
    // Filter
    let filtered = allServices.filter(service => {
        const matchesSearch = service.name.toLowerCase().includes(searchTerm) || 
                            (service.description && service.description.toLowerCase().includes(searchTerm));
        const matchesCategory = !categoryFilter || service.category_id == categoryFilter;
        return matchesSearch && matchesCategory;
    });
    
    // Sort
    filtered.sort((a, b) => {
        switch(sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'price-low':
                return parseFloat(a.price) - parseFloat(b.price);
            case 'price-high':
                return parseFloat(b.price) - parseFloat(a.price);
            case 'duration':
                return parseInt(a.duration_mins ?? a.duration) - parseInt(b.duration_mins ?? b.duration);
            default:
                return 0;
        }
    });
    
    displayServices(filtered);
}

function bookService(serviceId, serviceName) {
    // Check if user is logged in
    const token = localStorage.getItem(window.APP_CONFIG.TOKEN_KEY);
    
    if (!token) {
        // Redirect to login
        if (confirm(`Please login to book ${serviceName}. Redirect to login page?`)) {
            window.location.href = window.APP_CONFIG.URLS.login;
        }
    } else {
        // Redirect to booking page with service pre-selected
        // if serviceType is home, propagate type so booking page can pre-select home flow
        const q = serviceType === 'home' ? `?book=${serviceId}&type=home` : `?book=${serviceId}`;
        window.location.href = `${window.APP_CONFIG.URLS.customerDashboard}${q}`;
    }
}
</script>
{% endblock %}
